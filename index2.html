<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Color Grid App</title>
  <style>
    :root{
      --icon-size:26px;
      --save-dot-size:12px;
      --btn-size:50px;
      --gap:3px; /* מפרידים שחורים */
      --tile-radius:2px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#111;color:#eaeaea;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .app{min-height:100%;display:grid;place-items:center;padding:24px}
    .wrap{width:min(92vmin,720px)}
    .board{
      background:#000;
      display:grid;
      grid-template-columns:repeat(var(--n,8),1fr);
      gap:var(--gap);
      border:var(--gap) solid #000; /* מסגרת שחורה היקפית */
      border-radius:6px;
      user-select:none;
      touch-action:none;
    }
    .tile{
      aspect-ratio:1/1;
      width:100%;
      border-radius:var(--tile-radius);
      outline:none;
      box-shadow:0 0 0 0 rgba(255,255,255,0);
    }
    .tile:focus-visible{box-shadow:inset 0 0 0 3px rgba(255,255,255,0.9)}
    /* היילייט מטרה לגרירה / הדבקה (לא יוצא ליצוא) */
    .drag-target,.paste-armed{box-shadow:inset 0 0 0 4px #fff,0 0 0 0 rgba(255,255,255,0)}
    /* בקרות: שתי שורות ממורכזות */
    .controls{
      display:grid;
      justify-content:center;
      gap:14px;
      margin-top:44px; /* ≥ 40px מהגריד */
    }
    .controls-row{
      display:flex;
      justify-content:center;
      gap:16px;
      flex-wrap:wrap;
    }
    .btn{
      width:var(--btn-size);
      height:var(--btn-size);
      border-radius:14px;
      background:#1f1f1f;
      border:1px solid #2a2a2a;
      display:grid;place-items:center;
      cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      outline:none;
    }
    .btn:hover{background:#232323}
    .btn:active{transform:translateY(1px) scale(0.98)}
    .btn:focus-visible{box-shadow:0 0 0 2px #fff3}
    .glyph{position:relative;width:var(--icon-size);height:var(--icon-size);display:block}
    /* Reset: ריבוע שחור עם מסגרת זהב */
    .icon-reset::before{content:"";position:absolute;inset:0;background:#000;border:3px solid #FFD700;border-radius:3px}
    /* Randomize: עיגול חצי שחור/חצי לבן */
    .icon-random::before{content:"";position:absolute;inset:0;border-radius:50%;background:linear-gradient(90deg,#000 50%,#fff 50%);border:2px solid #222}
    /* Palette: אימוג'י */
    .palette-emoji{font-size:var(--icon-size);line-height:1}
    /* Resize: האשטג ב-SVG */
    .icon-resize svg{width:100%;height:100%;display:block}
    /* Save: נקודה לבנה קטנה במרכז */
    .icon-save::before{content:"";position:absolute;width:var(--save-dot-size);height:var(--save-dot-size);border-radius:50%;background:#fff;left:50%;top:50%;transform:translate(-50%,-50%)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1px,1px);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="app">
    <div class="wrap">
      <div id="board" class="board" aria-label="לוח צבעים" role="grid"></div>

      <!-- שתי שורות בקרה ממורכזות -->
      <div class="controls" aria-label="בקרות">
        <!-- שורה עליונה: רק רנדומליות + החלפת פלטה -->
        <div class="controls-row" id="controlsTop">
          <button id="btnRandom" class="btn" aria-label="רנדומליות" title="Randomize (active palette)">
            <span class="glyph icon-random" aria-hidden="true"></span>
          </button>

          <button id="btnPalette" class="btn" aria-label="החלפת פלטה" title="Palette">
            <span id="paletteEmoji" class="palette-emoji" aria-hidden="true">🌓</span>
            <span class="sr-only" id="paletteName">Default</span>
          </button>
        </div>

        <!-- שורה תחתונה: איפוס, שינוי גודל, שמירה -->
        <div class="controls-row" id="controlsBottom">
          <button id="btnReset" class="btn" aria-label="איפוס לזהב" title="Reset to Gold">
            <span class="glyph icon-reset" aria-hidden="true"></span>
          </button>

          <button id="btnResize" class="btn" aria-label="שינוי גודל" title="Resize (#)">
            <span class="glyph icon-resize" aria-hidden="true">
              <svg viewBox="0 0 100 100" fill="none" stroke="#eaeaea" stroke-width="8" stroke-linecap="round">
                <path d="M25 20v60M75 20v60M15 40h70M15 60h70"/>
              </svg>
            </span>
          </button>

          <button id="btnSave" class="btn" aria-label="שמור PNG" title="Save PNG">
            <span class="glyph icon-save" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ספריית יצוא ל-PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
  (function(){
    /*** פלטות ***/
    const PALETTES = [
      {
        name: 'Default', emoji: '🌓', /* 64 צבעים — כמו במפרט המקורי */
        colors: [
          /* Yellows / Golds */
          '#FFD700','#FFC107','#FFEE58','#FDD835','#FBC02D','#FFE082','#FFCA28','#FFF176',
          /* Oranges */
          '#FF8C00','#FF9800','#FB8C00','#FFA726','#FF7043','#FF5722','#F4511E','#F57C00',
          /* Reds */
          '#FF1744','#F44336','#E53935','#D32F2F','#C62828','#B71C1C','#FF5252','#EF5350',
          /* Pinks / Magentas */
          '#E91E63','#F06292','#FF4081','#AD1457','#D81B60','#C2185B','#EC407A','#F48FB1',
          /* Purples / Violets */
          '#9C27B0','#7B1FA2','#8E24AA','#AB47BC','#673AB7','#5E35B1','#3F51B5','#3949AB',
          /* Blues / Teals */
          '#2196F3','#1976D2','#1E88E5','#42A5F5','#00BCD4','#26C6DA','#0097A7','#80DEEA',
          /* Greens / Limes */
          '#4CAF50','#43A047','#2E7D32','#66BB6A','#8BC34A','#9CCC65','#CDDC39','#AFB42B',
          /* Neutrals */
          '#FFFFFF','#F5F5F5','#E0E0E0','#BDBDBD','#9E9E9E','#757575','#424242','#000000'
        ]
      },
      { name: 'New-York Autumn', emoji: '🍂', colors: [
        '#8B3A3A','#A52A2A','#8B0000','#B22222','#D2691E','#FF8C00','#FF7F50','#F4A460',
        '#CD853F','#C2A14A','#B8860B','#DAA520','#808000','#556B2F','#6B8E23','#8B4513',
        '#5D4037','#4E342E','#3E2723','#2F4F4F','#37474F','#607D8B','#795548'
      ]},
      { name: 'Brazilian Summer', emoji: '☀️', colors: [
        '#00FF7F','#1DE9B6','#00E676','#00C853','#2ECC71','#00A86B','#FFD700','#FFEB3B',
        '#FFC107','#FDD835','#00BFFF','#1E90FF','#00B0FF','#18FFFF','#40E0D0','#FF1493',
        '#FF69B4','#FF7F50','#FF5722','#F50057','#2962FF','#64DD17','#00C4FF'
      ]},
      { name: 'Icelandic Winter', emoji: '❄️', colors: [
        '#E6F7FF','#E1F5FE','#B3E5FC','#81D4FA','#4FC3F7','#29B6F6','#03A9F4','#90A4AE',
        '#B0BEC5','#CFD8DC','#ECEFF1','#FFFFFF','#F5F5F5','#BDBDBD','#9E9E9E','#78909C',
        '#546E7A','#455A64','#37474F','#263238','#A7FFEB','#80DEEA','#4DD0E1'
      ]},
      { name: 'Japanese Spring', emoji: '🌸', colors: [
        '#FFC0CB','#FFB7C5','#FFD1DC','#F8BBD0','#F48FB1','#E6E6FA','#D1C4E9','#B39DDB',
        '#C1E1C1','#A5D6A7','#81C784','#DCEDC8','#FFF8DC','#FFF9C4','#FFF59D','#FFECB3',
        '#87CEFA','#90CAF9','#64B5F6','#B3E5FC','#81D4FA','#80DEEA','#A7FFEB'
      ]},
      { name: 'Amazon Rainforest', emoji: '🌳', colors: [
        '#013220','#145A32','#1E8449','#229954','#28B463','#2ECC71','#58D68D','#82E0AA',
        '#A9DFBF','#196F3D','#27AE60','#52BE80','#239B56','#1D8348','#117A65','#0E6655',
        '#73C6B6','#48C9B0','#16A085','#45B39D','#138D75','#117864','#0B5345'
      ]},
      { name: 'Sahara Desert', emoji: '🏜️', colors: [
        '#F4E1A1','#E2C275','#CDA434','#B68900','#E59866','#CA6F1E','#F5CBA7','#EDBB99',
        '#E67E22','#D35400','#BA4A00','#A04000','#873600','#784212','#6E2C00','#935116',
        '#B9770E','#9C640C','#7E5109','#5D6D7E','#34495E','#2C3E50','#212F3C'
      ]},
      { name: 'Cosmos', emoji: '🌌', colors: [
        '#000000','#0B0C10','#1F2833','#263238','#37474F','#483D8B','#4B0082','#8A2BE2',
        '#9370DB','#BA55D3','#DA70D6','#FF00FF','#FF69B4','#F8F8FF','#FFFFFF','#FFFACD',
        '#E0FFFF','#B0E0E6','#40E0D0','#00BFFF','#1E90FF','#00008B','#191970'
      ]}
    ];

    // סדר המעבר נשען על המערך למעלה
    let activePaletteIndex = 0; // Default 🌓
    let n = 8; // גודל ברירת מחדל
    const GOLD = '#FFD700';
    let clipboardIndex = null;

    // סטייט של לחיצה/גרירה
    const pointerState = {
      id:null,downEl:null,downX:0,downY:0,
      longPressTimer:null,cyclingInterval:null,
      suppressClick:false,dragging:false,dragSource:null,currentTarget:null
    };

    const board = document.getElementById('board');
    function palette(){ return PALETTES[activePaletteIndex].colors; }

    // בניית אריח
    let initialBuildGoldOverlay = true;
    function createTile(idx=0){
      const d=document.createElement('div');
      d.className='tile';
      d.setAttribute('role','gridcell');
      d.setAttribute('tabindex','0');
      setIndex(d,idx);
      if(initialBuildGoldOverlay) applyGoldOverlay(d);
      return d;
    }
    function setIndex(el,k){
      el.dataset.k=String(k);
      if(!el.dataset.goldOverlay){
        const m=palette().length;
        el.style.background = palette()[((k % m)+m)%m];
      }
    }
    function getIndex(el){ return parseInt(el.dataset.k||'0',10); }
    function applyGoldOverlay(el){ el.style.background=GOLD; el.dataset.goldOverlay='1'; }
    function clearGoldOverlay(el){
      if(el.dataset.goldOverlay){
        delete el.dataset.goldOverlay;
        const k=getIndex(el);
        const m=palette().length;
        el.style.background = palette()[k % m];
      }
    }

    function buildBoard(size){
      board.style.setProperty('--n', size);
      board.innerHTML='';
      const frag=document.createDocumentFragment();
      for(let i=0;i<size*size;i++) frag.appendChild(createTile(0));
      board.appendChild(frag);
      const first=board.querySelector('.tile'); if(first) first.focus();
    }

    // פעולות גריד
    function cycleTile(el,step=1){ clearGoldOverlay(el); setIndex(el, getIndex(el)+step); }
    function randomizeAll(){
      const m=palette().length;
      board.querySelectorAll('.tile').forEach(el=>{
        clearGoldOverlay(el);
        setIndex(el, Math.floor(Math.random()*m));
      });
    }
    function resetToGold(){
      board.querySelectorAll('.tile').forEach(el=>{ setIndex(el,0); applyGoldOverlay(el); });
    }
    function switchPalette(){
      activePaletteIndex=(activePaletteIndex+1)%PALETTES.length;
      const pal=PALETTES[activePaletteIndex];
      document.getElementById('paletteEmoji').textContent=pal.emoji;
      document.getElementById('paletteName').textContent=pal.name;
      const m=pal.colors.length;
      board.querySelectorAll('.tile').forEach(el=>{
        if(!el.dataset.goldOverlay){
          const k=getIndex(el);
          el.style.background=pal.colors[k % m];
        }
      });
    }
    function resizeGrid(){
      const input=prompt('הכנס n (יבנה n×n ויאפס לזהב):', String(n));
      if(input===null) return;
      const value=parseInt(String(input).trim(),10);
      if(!Number.isFinite(value) || value<=0) return;
      n=value; initialBuildGoldOverlay=true; buildBoard(n);
    }

    async function savePNG(){
      const toStrip=Array.from(board.querySelectorAll('.drag-target,.paste-armed'));
      toStrip.forEach(el=>el.classList.remove('drag-target','paste-armed'));
      try{
        const canvas=await html2canvas(board,{backgroundColor:'#000000',scale:2});
        const link=document.createElement('a');
        link.download='board.png';
        link.href=canvas.toDataURL('image/png');
        link.click();
      }finally{
        // נחזיר היילייטים אם צריך
        if(clipboardIndex!=null){
          const f=document.activeElement && document.activeElement.classList?.contains('tile') ? document.activeElement : null;
          if(f) f.classList.add('paste-armed');
        }
      }
    }

    /*** אינטראקציות מצביע ***/
    const HOLD_DELAY=200, CYCLE_INTERVAL=80, DRAG_THRESHOLD=8;

    function onPointerDown(e){
      const el=e.target.closest('.tile'); if(!el) return;
      e.preventDefault(); el.setPointerCapture(e.pointerId);
      pointerState.id=e.pointerId; pointerState.downEl=el;
      pointerState.downX=e.clientX; pointerState.downY=e.clientY;
      pointerState.suppressClick=false; pointerState.dragging=false;
      pointerState.dragSource=null; pointerState.currentTarget=null;
      pointerState.longPressTimer=setTimeout(()=>{
        if(pointerState.dragging) return;
        pointerState.cyclingInterval=setInterval(()=>cycleTile(el,1), CYCLE_INTERVAL);
      }, HOLD_DELAY);
    }
    function enterDragMode(sourceEl){
      pointerState.dragging=true; pointerState.dragSource=sourceEl;
      pointerState.suppressClick=true;
    }
    function updateDragTarget(x,y){
      const el=document.elementFromPoint(x,y);
      const tile=el && el.closest ? el.closest('.tile') : null;
      if(pointerState.currentTarget===tile) return;
      if(pointerState.currentTarget) pointerState.currentTarget.classList.remove('drag-target');
      pointerState.currentTarget=tile;
      if(tile) tile.classList.add('drag-target');
    }
    function onPointerMove(e){
      if(pointerState.id!==e.pointerId) return;
      const dx=e.clientX-pointerState.downX;
      const dy=e.clientY-pointerState.downY;
      const dist=Math.hypot(dx,dy);
      if(!pointerState.dragging && dist>=DRAG_THRESHOLD){
        clearTimeout(pointerState.longPressTimer); pointerState.longPressTimer=null;
        if(pointerState.cyclingInterval){ clearInterval(pointerState.cyclingInterval); pointerState.cyclingInterval=null; }
        enterDragMode(pointerState.downEl);
      }
      if(pointerState.dragging) updateDragTarget(e.clientX,e.clientY);
    }
    function onPointerUp(e){
      const tile=e.target.closest('.tile');
      clearTimeout(pointerState.longPressTimer); pointerState.longPressTimer=null;
      if(pointerState.cyclingInterval){ clearInterval(pointerState.cyclingInterval); pointerState.cyclingInterval=null; pointerState.suppressClick=true; }
      if(pointerState.dragging){
        if(pointerState.currentTarget){
          clearGoldOverlay(pointerState.currentTarget);
          const k=getIndex(pointerState.dragSource);
          setIndex(pointerState.currentTarget, k);
          pointerState.currentTarget.classList.remove('drag-target');
        }
        pointerState.dragging=false; pointerState.dragSource=null; pointerState.currentTarget=null;
      } else if(!pointerState.suppressClick && tile){
        cycleTile(tile,1);
      }
      pointerState.id=null; pointerState.downEl=null;
    }
    function onPointerCancel(){
      clearTimeout(pointerState.longPressTimer); pointerState.longPressTimer=null;
      if(pointerState.cyclingInterval){ clearInterval(pointerState.cyclingInterval); pointerState.cyclingInterval=null; }
      if(pointerState.currentTarget) pointerState.currentTarget.classList.remove('drag-target');
      pointerState.dragging=false; pointerState.dragSource=null; pointerState.currentTarget=null;
      pointerState.id=null; pointerState.downEl=null;
    }
    board.addEventListener('pointerdown', onPointerDown);
    board.addEventListener('pointermove', onPointerMove);
    board.addEventListener('pointerup', onPointerUp);
    board.addEventListener('pointercancel', onPointerCancel);

    /*** מקלדת ***/
    let keyHoldInterval=null, keyHoldTimer=null;
    function startKeyHold(el){ keyHoldInterval=setInterval(()=>cycleTile(el,1), CYCLE_INTERVAL); }
    function stopKeyHold(){ clearInterval(keyHoldInterval); keyHoldInterval=null; clearTimeout(keyHoldTimer); keyHoldTimer=null; }
    function applyPasteArmedToFocused(){
      board.querySelectorAll('.tile').forEach(el=>el.classList.remove('paste-armed'));
      if(clipboardIndex!=null){
        const f=document.activeElement && document.activeElement.classList.contains('tile') ? document.activeElement : null;
        if(f) f.classList.add('paste-armed');
      }
    }
    board.addEventListener('keydown', (e)=>{
      const el=e.target.closest('.tile'); if(!el) return;
      if(e.code==='Space' || e.code==='Enter'){
        e.preventDefault();
        if(keyHoldInterval||keyHoldTimer) return;
        keyHoldTimer=setTimeout(()=>startKeyHold(el), HOLD_DELAY);
      }else if(e.key.toLowerCase()==='c'){
        clipboardIndex=getIndex(el); applyPasteArmedToFocused();
      }else if(e.key.toLowerCase()==='v'){
        if(clipboardIndex!=null){ clearGoldOverlay(el); setIndex(el,clipboardIndex); el.classList.add('paste-armed'); setTimeout(()=>el.classList.remove('paste-armed'),120); }
      }
    });
    board.addEventListener('keyup', (e)=>{
      const el=e.target.closest('.tile'); if(!el) return;
      if(e.code==='Space' || e.code==='Enter'){
        e.preventDefault();
        if(keyHoldTimer){ clearTimeout(keyHoldTimer); keyHoldTimer=null; cycleTile(el,1); }
        else if(keyHoldInterval){ stopKeyHold(); }
      }
    });
    board.addEventListener('focusin', applyPasteArmedToFocused);
    board.addEventListener('focusout', (e)=>{
      const to=e.relatedTarget;
      if(!to || !board.contains(to)){ board.querySelectorAll('.tile').forEach(el=>el.classList.remove('paste-armed')); }
    });

    /*** כפתורים ***/
    document.getElementById('btnRandom').addEventListener('click', randomizeAll);
    document.getElementById('btnPalette').addEventListener('click', switchPalette);
    document.getElementById('btnReset').addEventListener('click', resetToGold);
    document.getElementById('btnResize').addEventListener('click', resizeGrid);
    document.getElementById('btnSave').addEventListener('click', savePNG);

    /*** Init ***/
    buildBoard(n);
  })();
  </script>
</body>
</html>
